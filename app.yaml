name: astrobsm-app
services:
  - name: backend
    environment_slug: python
    source_dir: backend
    run_command: uvicorn app.main:app --host 0.0.0.0 --port 8080
    build_command: |
      export DISABLE_ALEMBIC_REVISION=1
      export SKIP_ALEMBIC_UPGRADE=1
      pip install --upgrade pip
      pip install -r requirements.txt
      ls -la ../frontend/
      cd ../frontend/react-app && npm install && NODE_ENV=production npm run build
      ls -la build/
      mkdir -p ../../backend/app/static
      cp -r build/* ../../backend/app/static/
      ls -la ../../backend/app/static/
    http_port: 8080
    routes:
      - path: /
    envs:
      - key: DATABASE_URL
        value: <your_database_url>
      - key: SECRET_KEY
        value: <your_secret_key>
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: false

jobs:
  - name: migrate
    environment_slug: python
    source_dir: backend
    run_command: python -m alembic upgrade head
    envs:
      - key: DATABASE_URL
        value: <your_database_url>
      - key: SECRET_KEY
        value: <your_secret_key>
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: false
